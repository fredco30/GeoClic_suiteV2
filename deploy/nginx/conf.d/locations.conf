# ═══════════════════════════════════════════════════════════════════════════════
# Locations Nginx - GéoClic Suite V14
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# API FASTAPI
# ═══════════════════════════════════════════════════════════════════════════════
location /api {
    limit_req zone=api_limit burst=50 nodelay;

    proxy_pass http://api_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
}

# Endpoint de login avec rate limiting strict
location /api/auth/login {
    limit_req zone=login_limit burst=3 nodelay;

    proxy_pass http://api_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ═══════════════════════════════════════════════════════════════════════════════
# PORTAIL CITOYEN (QR Codes)
# ═══════════════════════════════════════════════════════════════════════════════
location /e/ {
    # Redirection des codes courts vers l'API publique
    rewrite ^/e/(.+)$ /api/public/equipment/$1 redirect;
}

# ═══════════════════════════════════════════════════════════════════════════════
# INTERFACE ADMIN (GéoClic Data)
# ═══════════════════════════════════════════════════════════════════════════════
location /admin {
    proxy_pass http://admin_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# PORTAIL CITOYEN (Interface publique de signalement)
# ═══════════════════════════════════════════════════════════════════════════════
location /portail {
    proxy_pass http://portail_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# GESTION DES DEMANDES (Back-office agents)
# ═══════════════════════════════════════════════════════════════════════════════
location /demandes {
    proxy_pass http://demandes_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# MOBILE PWA (Relevé terrain)
# ═══════════════════════════════════════════════════════════════════════════════
location /mobile {
    proxy_pass http://mobile_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# SIG WEB (GéoClic SIG - Cartographie)
# ═══════════════════════════════════════════════════════════════════════════════
location /sig {
    proxy_pass http://sig_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# GEOCLIC SERVICES (Services terrain)
# ═══════════════════════════════════════════════════════════════════════════════
location /services {
    proxy_pass http://services_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# ═══════════════════════════════════════════════════════════════════════════════
# GEOCLIC TERRAIN PWA (Services terrain mobile)
# ═══════════════════════════════════════════════════════════════════════════════
location /terrain {
    proxy_pass http://terrain_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# PWA Service Worker - pas de cache
location = /terrain/sw.js {
    proxy_pass http://terrain_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    expires off;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# ═══════════════════════════════════════════════════════════════════════════════
# FICHIERS STATIQUES (Photos et documents)
# ═══════════════════════════════════════════════════════════════════════════════
location /photos {
    alias /app/photos;
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options nosniff;

    # Formats autorisés (images + documents)
    location ~* \.(jpg|jpeg|png|gif|webp|pdf|doc|docx|odt|xls|xlsx|txt|csv)$ {
        valid_referers none blocked server_names;
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# SITE VITRINE (Landing pages marketing)
# ═══════════════════════════════════════════════════════════════════════════════
location / {
    root /var/www;
    index index.html;
    try_files $uri $uri/ /index.html;

    # Cache pour les assets
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}

# Fleet Manager (serveur maître uniquement)
# Ce fichier n'existe que sur le maître, le glob ne génère pas d'erreur s'il est absent
include /etc/nginx/conf.d/fleet*.conf;

# Health check
location /health {
    access_log off;
    return 200 "OK";
    add_header Content-Type text/plain;
}

# Robots.txt
location /robots.txt {
    return 200 "User-agent: *\nDisallow: /api/\nDisallow: /admin/\nDisallow: /demandes/\n";
    add_header Content-Type text/plain;
}
